PelletsPerShot = {}
PelletsPerShot[0]=0 -- unarmed
PelletsPerShot[1]=0 -- knuckles
PelletsPerShot[2]=0 -- golf club
PelletsPerShot[3]=0 -- knite stick
PelletsPerShot[4]=0 -- knive
PelletsPerShot[5]=0 -- baseball bat
PelletsPerShot[6]=0 -- shovel
PelletsPerShot[7]=0 -- pool cue
PelletsPerShot[8]=0 -- kantana
PelletsPerShot[9]=0 -- chainsaw
PelletsPerShot[10]=0 -- purple dildo
PelletsPerShot[11]=0 -- short vibrator
PelletsPerShot[12]=0 -- loooong vibrator
PelletsPerShot[13]=0 -- white dildo
PelletsPerShot[14]=0 -- flowers
PelletsPerShot[15]=0 -- cane
PelletsPerShot[16]=0 -- grenades
PelletsPerShot[17]=0 -- tear gas
PelletsPerShot[18]=0 -- molotov cocktail
PelletsPerShot[19]=0 -- vehicle missile
PelletsPerShot[20]=0 -- hydra flare
PelletsPerShot[21]=0 -- jetpack
PelletsPerShot[22]=1 -- normal pistol, single
PelletsPerShot[23]=1 -- silenced 9mm
PelletsPerShot[24]=1 -- desert eagle
PelletsPerShot[25]=6 -- shotgun
PelletsPerShot[26]=12 -- sawnoff shotgun, single
PelletsPerShot[27]=5 -- combat shotgun
PelletsPerShot[28]=1 -- uzi MAC 10
PelletsPerShot[29]=1 -- MP5
PelletsPerShot[30]=1 -- AK47
PelletsPerShot[31]=1 -- M4
PelletsPerShot[32]=1 -- TEC9
PelletsPerShot[33]=1 -- country rifle
PelletsPerShot[34]=1 -- sniper rifle
PelletsPerShot[35]=0 -- RPG
PelletsPerShot[36]=0 -- heatseeking RPG
PelletsPerShot[37]=0 -- flamethrower
PelletsPerShot[38]=1 -- Minigun
PelletsPerShot[39]=0 -- sachtel charges
PelletsPerShot[40]=0 -- detonator
PelletsPerShot[41]=0 -- spray can
PelletsPerShot[42]=0 -- fire extinguisher
PelletsPerShot[43]=0 -- camera
PelletsPerShot[44]=0 -- NV Googles
PelletsPerShot[45]=0 -- Thermal Googles
PelletsPerShot[46]=0 -- Parachute
PelletsPerShot[47]=0 -- fake pistol

--weapon recoil
WeaponRecoil = {}
WeaponRecoil[0]=0 -- unarmed
WeaponRecoil[1]=0 -- knuckles
WeaponRecoil[2]=0 -- golf club
WeaponRecoil[3]=0 -- knite stick
WeaponRecoil[4]=0 -- knive
WeaponRecoil[5]=0 -- baseball bat
WeaponRecoil[6]=0 -- shovel
WeaponRecoil[7]=0 -- pool cue
WeaponRecoil[8]=0 -- kantana
WeaponRecoil[9]=0 -- chainsaw
WeaponRecoil[10]=0 -- purple dildo
WeaponRecoil[11]=0 -- short vibrator
WeaponRecoil[12]=0 -- loooong vibrator
WeaponRecoil[13]=0 -- white dildo
WeaponRecoil[14]=0 -- flowers
WeaponRecoil[15]=0 -- cane
WeaponRecoil[16]=0 -- grenades
WeaponRecoil[17]=0 -- tear gas
WeaponRecoil[18]=0 -- molotov cocktail
WeaponRecoil[19]=0 -- vehicle missile
WeaponRecoil[20]=0 -- hydra flare
WeaponRecoil[21]=0 -- jetpack
WeaponRecoil[22]=10 -- normal pistol, single
WeaponRecoil[23]=5 -- silenced 9mm
WeaponRecoil[24]=10 -- desert eagle
WeaponRecoil[25]=20 -- shotgun
WeaponRecoil[26]=25 -- sawnoff shotgun, single
WeaponRecoil[27]=20 -- combat shotgun
WeaponRecoil[28]=20 -- uzi MAC 10
WeaponRecoil[29]=20 -- MP5
WeaponRecoil[30]=20 -- AK47
WeaponRecoil[31]=20 -- M4
WeaponRecoil[32]=0 -- TEC9
WeaponRecoil[33]=30 -- country rifle
WeaponRecoil[34]=30 -- sniper rifle
WeaponRecoil[35]=0 -- RPG
WeaponRecoil[36]=0 -- heatseeking RPG
WeaponRecoil[37]=0 -- flamethrower
WeaponRecoil[38]=0 -- Minigun
WeaponRecoil[39]=0 -- sachtel charges
WeaponRecoil[40]=0 -- detonator
WeaponRecoil[41]=0 -- spray can
WeaponRecoil[42]=0 -- fire extinguisher
WeaponRecoil[43]=0 -- camera
WeaponRecoil[44]=0 -- NV Googles
WeaponRecoil[45]=0 -- Thermal Googles
WeaponRecoil[46]=0 -- Parachute
WeaponRecoil[47]=100 -- fake pistol

--weapon inaccuracy
WeaponInaccuracy = {}
WeaponInaccuracy[0]=0 -- unarmed
WeaponInaccuracy[1]=0 -- knuckles
WeaponInaccuracy[2]=0 -- golf club
WeaponInaccuracy[3]=0 -- knite stick
WeaponInaccuracy[4]=0 -- knive
WeaponInaccuracy[5]=0 -- baseball bat
WeaponInaccuracy[6]=0 -- shovel
WeaponInaccuracy[7]=0 -- pool cue
WeaponInaccuracy[8]=0 -- kantana
WeaponInaccuracy[9]=0 -- chainsaw
WeaponInaccuracy[10]=0 -- purple dildo
WeaponInaccuracy[11]=0 -- short vibrator
WeaponInaccuracy[12]=0 -- loooong vibrator
WeaponInaccuracy[13]=0 -- white dildo
WeaponInaccuracy[14]=0 -- flowers
WeaponInaccuracy[15]=0 -- cane
WeaponInaccuracy[16]=0 -- grenades
WeaponInaccuracy[17]=0 -- tear gas
WeaponInaccuracy[18]=0 -- molotov cocktail
WeaponInaccuracy[19]=0 -- vehicle missile
WeaponInaccuracy[20]=0 -- hydra flare
WeaponInaccuracy[21]=0 -- jetpack
WeaponInaccuracy[22]=0 -- normal pistol, single 50
WeaponInaccuracy[23]=0 -- silenced 9mm 20
WeaponInaccuracy[24]=0 -- desert eagle 50
WeaponInaccuracy[25]=0 -- shotgun 200
WeaponInaccuracy[26]=0 -- sawnoff shotgun, single 250
WeaponInaccuracy[27]=0 -- combat shotgun 180
WeaponInaccuracy[28]=0 -- uzi 50
WeaponInaccuracy[29]=0 -- MP5 40
WeaponInaccuracy[30]=0 -- AK47 20
WeaponInaccuracy[31]=0 -- M4 20
WeaponInaccuracy[32]=0 -- TEC9 5
WeaponInaccuracy[33]=0 -- country rifle 5
WeaponInaccuracy[34]=0 -- sniper rifle
WeaponInaccuracy[35]=0 -- RPG
WeaponInaccuracy[36]=0 -- heatseeking RPG
WeaponInaccuracy[37]=0 -- flamethrower
WeaponInaccuracy[38]=0 -- Minigun 5
WeaponInaccuracy[39]=0 -- sachtel charges
WeaponInaccuracy[40]=0 -- detonator
WeaponInaccuracy[41]=0 -- spray can
WeaponInaccuracy[42]=0 -- fire extinguisher
WeaponInaccuracy[43]=0 -- camera
WeaponInaccuracy[44]=0 -- NV Googles
WeaponInaccuracy[45]=0 -- Thermal Googles
WeaponInaccuracy[46]=0 -- Parachute
WeaponInaccuracy[47]=0 -- fake pistol

---------------------------------------------------------------------------------------------
lastShotTime          = 1;
lastRecoil            = 0;
chainsawTimer         = nil;
fire_stop             = true;
fCalcDistance         = 300;
---------------------------------------------------------------------------------------------
bAcceptGasGrenade = true
function SYNCRO_GASGRENADE(element)
	if bAcceptGasGrenade == true then
		local fPx,fPy,fPz = getElementPosition(element);
		triggerServerEvent("S_GASGRENADE",getLocalPlayer(),fPx,fPy,fPz);
	end
end
---------------------------------------------------------------------------------------------
function SYNCRO_INIT()
	if source == getThisResource() then
		outputDebugString("starting sync...");
	end
	bIsSpawned = nil;
	setTimer(setSpawned,4000,1)
end

function syncro (attacker,weap,bodyp,loss)
	--attacker returns bool on falling damage
		local health = getElementHealth(source)
		local hploss = health * loss/100
		local ax,ay,az
		local tx,ty,tz
		
	if not attacker and source == localPlayer then 
		if hploss> 10 and hploss< 30 then setElementData(localPlayer,"minorfracture",true) elseif hploss>= 30 then setElementData(localPlayer,"majorfracture",true) end
		return
	end
	
	if attacker then 
		ax,ay,az = getElementPosition(attacker) 
		tx,ty,tz = getElementPosition(source)
	else 
		ax,ay,az = 0,0,0
		tx,ty,tz = getElementPosition(source)
	end
	
	
	if attacker then
		if getElementType(attacker) =="vehicle" then 
			if hploss ~= 0 then
			triggerEvent("sync.message", root, source, 255, 204, 0, "SMASHED")
			end
			return 
		elseif getElementType(attacker) =="ped" and getDistanceBetweenPoints3D(ax,ay,az,tx,ty,tz)<1 then
			triggerServerEvent("S_MELEE",attacker,source)
			triggerEvent("sync.message", root, source, 255, 50, 0, "HIT")
		else
		cancelEvent();
		end
	end
end

function onClientPlayerWeaponFireFunc(weapon, ammo, ammoInClip, hitX, hitY, hitZ, hitElement )
	if not getElementData(getLocalPlayer(),"S_AIM_RECOIL") and not getElementData(getLocalPlayer(),"S_AIM_ACCURACY") and not getElementData(getLocalPlayer(),"S_GUN_PELLET_MUL") and not getElementData(getLocalPlayer(),"S_AIM_RECOIL") then
		setElementData(getLocalPlayer(),"S_AIM_RECOIL",1);
		setElementData(getLocalPlayer(),"S_AIM_ACCURACY",1);
		setElementData(getLocalPlayer(),"S_GUN_PELLET_MUL",1);
	end
	onClientPlayerWeaponFireFunc_CallBack(source, weapon, ammo, ammoInClip, hitX, hitY, hitZ, hitElement );
end

function onClientPlayerWeaponFireFunc_CallBack(source, weapon, ammo, ammoInClip, hitX, hitY, hitZ, hitElement )
	if isPedDead( source ) --[[or iFrameCount < 1]] then -- old function! new one: isPedDead( ped )
		return; 
	end
	--iFrameCount = 0;
	local bodypart = "";
	local lineHitElement = nil;
	local PelletHits = 0;
	local aHits;
	local iHitCount = 0;
	if source == getLocalPlayer() then
                if (getElementData(source, "spawnp") ~="no") then
                        setElementData(source, "spawnp", "no");
                end
		if weapon > 0 and weapon < 48 then
			local cX,cY,cZ,aX,aY,aZ,roll,pov = getCameraMatrix();
			local vX,vY,vZ = hitX-cX,hitY-cY,hitZ-cZ;
			local hit, linehitX, linehitY, linehitZ;
			length = getDistanceBetweenPoints3D(0,0,0,vX,vY,vZ);
			evX,evY,evZ = vX/length,vY/length,vZ/length;
			pellets = math.ceil(PelletsPerShot[weapon] * getElementData(getLocalPlayer(),"S_GUN_PELLET_MUL"));
			if pellets > 10 then
				pellets = 10;
			end
			local lastHit = "";
			local defHitPlayer = nil;
			for loop_variable = 1,pellets,1 do
				local inaccuracy = WeaponInaccuracy[weapon]/10;
				if getTickCount() - lastShotTime  < 4000 then
					currentRecoil = ( (1000/(getTickCount() - lastShotTime)) * WeaponRecoil[weapon]/30 ) * getElementData(getLocalPlayer(),"S_AIM_RECOIL");
					inaccuracy    = ( inaccuracy + currentRecoil + lastRecoil ) * getElementData(getLocalPlayer(),"S_AIM_ACCURACY");
					lastRecoil    = currentRecoil*0.9 + lastRecoil*0.11;					
				end
				if isPedDucked ( getLocalPlayer() ) then -- OLD FUNCTION! NEW FUNCTION IS: isPedDucked ( ped thePed )
					inaccuracy = inaccuracy / 2;
				end
 				vX = evX * fCalcDistance + (math.random(0,1000)/1000 - 0.5)*inaccuracy;
				vY = evY * fCalcDistance + (math.random(0,1000)/1000 - 0.5)*inaccuracy;
				vZ = evZ * fCalcDistance + (math.random(0,1000)/1000 - 0.5)*inaccuracy;
				aX,aY,aZ = cX + vX, cY + vY, cZ + vZ;
				local pX,pY,pZ = getElementPosition ( getLocalPlayer() );
				local cameraPlayerDistance = getDistanceBetweenPoints3D(cX,cY,cZ,pX,pY,pZ) + 0.5;
				hit, lineHitX, lineHitY, lineHitZ, linehitElement = processLineOfSight (cX+evX*cameraPlayerDistance,cY+evY*cameraPlayerDistance,cZ+evZ*cameraPlayerDistance,aX,aY,aZ,true,true,true,true,false,false,true,true);
				if isElement(linehitElement) then
					iHitCount = iHitCount + 1;
					if iHitCount == 1 then
						aHits = {};
					end
					aHits[iHitCount] = {};
					aHits[iHitCount].element = linehitElement;
					heX,heY,heZ = getElementPosition(linehitElement);
					aHits[iHitCount].offX = lineHitX - heX;
					aHits[iHitCount].offY = lineHitY - heY;
					aHits[iHitCount].offZ = lineHitZ - heZ;
					aHits[iHitCount].hitX = lineHitX;
					aHits[iHitCount].hitY = lineHitY;
					aHits[iHitCount].hitZ = lineHitZ;
				elseif hit then
					iHitCount = iHitCount + 1;
					if iHitCount == 1 then
						aHits = {};
					end
					aHits[iHitCount] = {};
					aHits[iHitCount].offX = lineHitX;
					aHits[iHitCount].offY = lineHitY;
					aHits[iHitCount].offZ = lineHitZ;
					aHits[iHitCount].hitX = lineHitX;
					aHits[iHitCount].hitY = lineHitY;
					aHits[iHitCount].hitZ = lineHitZ;
				end
			end
		end
		lastShotTime = getTickCount();
		sX,sY,sZ = getElementPosition(source);
		triggerServerEvent("S_SHOOT",getLocalPlayer(),weapon,ammo,ammoInClip,aHits,getTickCount()/1000*45);
	end
end

function SYNCRO_WASTED()
	bIsSpawned = nil;
	bAcceptGasGrenade = nil;
	toggleControl( "fire", false)
	toggleControl( "enter_exit", false)
end

function SYNCRO_EXPLOSION(x,y,z,type)
	triggerServerEvent("S_CLIENTEXPL",getLocalPlayer(),source,x,y,z,type );
end

function setSpawned()
	bIsSpawned = true;
end

function SYNCRO_SPAWN()
	setTimer(setSpawned,4000,1)
	
	toggleControl( "fire", true)
	toggleControl( "enter_exit", true)
end

function SYNCRO_PROJECTILE ( creator )
	projectile = source;
	player = creator;
	if player == getLocalPlayer() and getProjectileType( projectile ) == 17 and getPedAmmoInClip(getLocalPlayer()) < 2 then
		bAcceptGasGrenade = true;
		setTimer( SYNCRO_GASGRENADE,5000,1,projectile );
	end
end

function SYNCRO_PEDWEAPONFIRE( weapon, ammo, ammoInClip, hitX, hitY, hitZ, hitElement )
	ped = source;
	target = getPedTarget ( ped );
	if target == getLocalPlayer() then
		triggerServerEvent("S_PEDSHOT",getLocalPlayer(),getLocalPlayer(),ped,weapon,hitX,hitY,hitZ);
	else
		triggerServerEvent("S_PEDSHOTPED",getLocalPlayer(),target,ped,weapon,hitX,hitY,hitZ);
	end
end

function SYNCRO_PED_WASTED ()
setPedAnimation(source)
end

---------------------------------------------------------------------------------------------
addEventHandler ( "onClientPlayerDamage", getRootElement(), syncro )
addEventHandler ( "onClientPedDamage", getRootElement(), syncro )
addEventHandler ( "onClientPlayerWeaponFire", getLocalPlayer(), onClientPlayerWeaponFireFunc )
addEventHandler ( "onClientWeaponFire", getLocalPlayer(), onClientPlayerWeaponFireFunc )
addEventHandler ( "onClientResourceStart",getRootElement(), SYNCRO_INIT )					
addEventHandler ( "onClientPlayerWasted", getLocalPlayer(), SYNCRO_WASTED )
addEventHandler ( "onClientPedWasted", root, SYNCRO_PED_WASTED )
addEventHandler ( "onClientExplosion", getRootElement(), SYNCRO_EXPLOSION )
addEventHandler ( "onClientPlayerSpawn", getLocalPlayer(), SYNCRO_SPAWN )
addEventHandler ( "onClientProjectileCreation", getRootElement(), SYNCRO_PROJECTILE )
addEventHandler ( "onClientPedWeaponFire" , getRootElement(), SYNCRO_PEDWEAPONFIRE )
---------------------------------------------------------------------------------------------

function setPlayerExplosionDamage(damage,explosion_source)
	triggerServerEvent("S_NORMALDAMAGE",getLocalPlayer(),damage,explosion_source);
end


function syncAExplosion(explosion_source,x,y,z,damage,range)
	--outputDebugString("EXPLOSION!");
	local hit, linehitX, linehitY, linehitZ;
	local pX,pY,pZ = getElementPosition(getLocalPlayer());
	local vX,vY,vZ = pX - x, pY - y, pZ - z;
	local explosionDistance = getDistanceBetweenPoints3D(x,y,z,pX,pY,pZ);
	if explosionDistance <= range then
		evX,evY,evZ = vX/explosionDistance,vY/explosionDistance,vZ/explosionDistance;
		hit, linehitX, linehitY, linehitZ, linehitElement = processLineOfSight (x + evX*2,y + evY*2,z + evZ*2,pX,pY,pZ);
		if not hit or linehitElement == getLocalPlayer() or explosionDistance < 2 then
			damage = damage * (range/(explosionDistance*explosionDistance + range));
			setElementVelocity(getLocalPlayer(),evX*damage/1000,evY*damage/1000,evZ + 0.001);
			damageMultiplier = getElementData(getLocalPlayer(),"S_DAMAGE_MULTIPLIER")
			if not damageMultiplier then
				damageMultiplier = 1;
			end
			setPlayerExplosionDamage(damage*damageMultiplier,explosion_source);
		end
	end
end

---------------------------------------------------------------------------------------------
addEvent("S_EXPLOSION",true)
addEventHandler("S_EXPLOSION",getLocalPlayer(),syncAExplosion);
---------------------------------------------------------------------------------------------

function SYNC_MELEE_START (attacker, weap, bpart)
	if attacker == localPlayer and weap ~= -1 and weap < 16 then
		fire_stop = false;
		SYNC_MELEE(source,attacker, weap, bpart);
	end
end

function SYNC_MELEE (elemhit,attacker, weap, bpart)
	local weapon    = getPedWeapon(getLocalPlayer());
	if (getTickCount() - lastShotTime) > (500/getGameSpeed()) and isControlEnabled ( "fire" ) or chainsawTimer then
		if (weapon == 9) and not fire_stop then
			chainsawTimer = setTimer(SYNC_MELEE,200/getGameSpeed(),1)
		end
		triggerServerEvent("S_MELEE",getLocalPlayer(),elemhit)
		lastShotTime = getTickCount()
	end
end

function SYNC_MELEE_STOP()
	fire_stop = true;
	if weapon == 9 and isControlEnabled ( "fire" ) then
		killTimer(chainsawTimer);
		chainsawTimer = nil;
	end
end

addEventHandler ( "onClientPedDamage", getRootElement(), SYNC_MELEE_START )
addEventHandler ( "onClientPlayerDamage", getRootElement(), SYNC_MELEE_START )

function SYNC_AIMING()
	playerIsAiming = true;
end

function SYNC_AIMING_STOP()
	playerIsAiming = false;
end

stomp_tick = getTickCount ()

function SYNC_STOMP()
	local weapon = getPedWeapon(localPlayer)
	if (playerIsAiming and  isControlEnabled ( "enter_exit" )) then
		local grab = isPedDucked(localPlayer)
		if grab and (weapon ~= -1 and (weapon < 16 or weapon == 37)) then
			triggerServerEvent("SyncWeapStomp",localPlayer,grab)
		elseif (weapon ~= -1 and (weapon > 16 and weapon ~= 37)) then
			local new_tick = getTickCount ()
			if new_tick >= stomp_tick + 2500 then
			triggerServerEvent("SyncWeapStomp",localPlayer,grab)
			stomp_tick = new_tick
			end
		end
	end
end

---------------------------------------------------------------------------------------------

bindKey ("fire", "up"  , SYNC_MELEE_STOP)
bindKey ("aim_weapon", "down", SYNC_AIMING)
bindKey ("aim_weapon", "up"  , SYNC_AIMING_STOP)
bindKey ("enter_exit", "down", SYNC_STOMP)

armedVehicles = {[425]=true, [520]=true, [476]=true, [447]=true, [430]=true, [432]=true, [464]=true, [407]=true, [601]=true}
function vehicleWeaponFire(key, keyState, vehicleFireType)
	local vehModel = getElementModel(getPedOccupiedVehicle(localPlayer))
	if (armedVehicles[vehModel]) then
		triggerEvent("onClientVehicleWeaponFire", localPlayer, vehicleFireType, vehModel)
	end
end
bindKey("vehicle_fire", "down", vehicleWeaponFire, "primary")
bindKey("vehicle_secondary_fire", "down", vehicleWeaponFire, "secondary")
